import { keymap } from 'prosemirror-keymap';
import { toggleMark, baseKeymap, chainCommands, exitCode } from 'prosemirror-commands';
import { splitListItem, liftListItem, sinkListItem } from 'prosemirror-schema-list';
import { history, undo, redo } from 'prosemirror-history';
import { inputRules, wrappingInputRule, textblockTypeInputRule, smartQuotes, emDash, ellipsis } from 'prosemirror-inputrules';
import { markInputRule } from 'ngx-editor/helpers';
const isMacOs = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
// Input rules ref: https://github.com/ProseMirror/prosemirror-example-setup/
// : (NodeType) → InputRule
// Given a blockquote node type, returns an input rule that turns `"> "`
// at the start of a textblock into a blockquote.
const blockQuoteRule = (nodeType) => {
    return wrappingInputRule(/^\s*>\s$/, nodeType);
};
// : (NodeType) → InputRule
// Given a list node type, returns an input rule that turns a number
// followed by a dot at the start of a textblock into an ordered list.
const orderedListRule = (nodeType) => {
    return wrappingInputRule(/^(\d+)\.\s$/, nodeType, match => ({ order: +match[1] }), (match, node) => node.childCount + node.attrs.order === +match[1]);
};
// : (NodeType) → InputRule
// Given a list node type, returns an input rule that turns a bullet
// (dash, plush, or asterisk) at the start of a textblock into a
// bullet list.
const bulletListRule = (nodeType) => {
    return wrappingInputRule(/^\s*([-+*])\s$/, nodeType);
};
// : (NodeType) → InputRule
// Given a code block node type, returns an input rule that turns a
// textblock starting with three backticks into a code block.
const codeBlockRule = (nodeType) => {
    return textblockTypeInputRule(/^```$/, nodeType);
};
// : (NodeType, number) → InputRule
// Given a node type and a maximum level, creates an input rule that
// turns up to that number of `#` characters followed by a space at
// the start of a textblock into a heading whose level corresponds to
// the number of `#` signs.
const headingRule = (nodeType, maxLevel) => {
    return textblockTypeInputRule(new RegExp('^(#{1,' + maxLevel + '})\\s$'), nodeType, (match) => ({ level: match[1].length }));
};
// : (MarkType) → InputRule
// Wraps matching text with bold mark
const boldRule = (markType) => {
    return markInputRule(/(?:^|\s)((?:\*\*|__)((?:[^*_]+))(?:\*\*|__))$/, markType);
};
// : (MarkType) → InputRule
// Wraps matching text with em mark
const emRule = (markType) => {
    return markInputRule(/(?:^|\s)((?:\*|_)((?:[^*_]+))(?:\*|_))$/, markType);
};
// : (Schema) → Plugin
// A set of input rules for creating the basic block quotes, lists,
// code blocks, and heading.
const buildInputRules = (schema) => {
    const rules = smartQuotes.concat(ellipsis, emDash);
    rules.push(boldRule(schema.marks.strong));
    rules.push(emRule(schema.marks.em));
    rules.push(blockQuoteRule(schema.nodes.blockquote));
    rules.push(orderedListRule(schema.nodes.ordered_list));
    rules.push(bulletListRule(schema.nodes.bullet_list));
    rules.push(codeBlockRule(schema.nodes.code_block));
    rules.push(headingRule(schema.nodes.heading, 6));
    return inputRules({ rules });
};
const getKeyboardShortcuts = (schema, options) => {
    const historyKeyMap = {};
    historyKeyMap['Mod-z'] = undo;
    if (isMacOs) {
        historyKeyMap['Shift-Mod-z'] = redo;
    }
    else {
        historyKeyMap['Mod-y'] = redo;
    }
    const plugins = [
        keymap({
            'Mod-b': toggleMark(schema.marks.strong),
            'Mod-i': toggleMark(schema.marks.em),
            'Mod-u': toggleMark(schema.marks.u),
            'Mod-`': toggleMark(schema.marks.code),
        }),
        keymap({
            Enter: splitListItem(schema.nodes.list_item),
            'Shift-Enter': chainCommands(exitCode, (state, dispatch) => {
                const tr = state.tr;
                const br = schema.nodes.hard_break;
                dispatch(tr.replaceSelectionWith(br.create()).scrollIntoView());
                return true;
            }),
            'Mod-[': liftListItem(schema.nodes.list_item),
            'Mod-]': sinkListItem(schema.nodes.list_item),
            Tab: sinkListItem(schema.nodes.list_item)
        }),
        keymap(baseKeymap)
    ];
    if (options.history) {
        plugins.push(keymap(historyKeyMap));
    }
    return plugins;
};
const getDefaultPlugins = (schema, options) => {
    const plugins = [];
    if (options.keyboardShortcuts) {
        plugins.push(...getKeyboardShortcuts(schema, { history: options.history }));
    }
    if (options.history) {
        plugins.push(history());
    }
    if (options.inputRules) {
        plugins.push(buildInputRules(schema));
    }
    return plugins;
};
export default getDefaultPlugins;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdFBsdWdpbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtZWRpdG9yL3NyYy9saWIvZGVmYXVsdFBsdWdpbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN2RixPQUFPLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNwRixPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEVBQ0wsVUFBVSxFQUFFLGlCQUFpQixFQUFFLHNCQUFzQixFQUNyRCxXQUFXLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFDOUIsTUFBTSx3QkFBd0IsQ0FBQztBQUVoQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFZbkQsTUFBTSxPQUFPLEdBQUcsT0FBTyxTQUFTLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFBO0FBRXpGLDZFQUE2RTtBQUU3RSwyQkFBMkI7QUFDM0Isd0VBQXdFO0FBQ3hFLGlEQUFpRDtBQUNqRCxNQUFNLGNBQWMsR0FBRyxDQUFDLFFBQWtCLEVBQWEsRUFBRTtJQUN2RCxPQUFPLGlCQUFpQixDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQztBQUNqRCxDQUFDLENBQUM7QUFFRiwyQkFBMkI7QUFDM0Isb0VBQW9FO0FBQ3BFLHNFQUFzRTtBQUN0RSxNQUFNLGVBQWUsR0FBRyxDQUFDLFFBQWtCLEVBQWEsRUFBRTtJQUN4RCxP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bWEgfSBmcm9tICdwcm9zZW1pcnJvci1tb2RlbCc7XG5pbXBvcnQgeyBQbHVnaW4gfSBmcm9tICdwcm9zZW1pcnJvci1zdGF0ZSc7XG5pbXBvcnQgeyBrZXltYXAgfSBmcm9tICdwcm9zZW1pcnJvci1rZXltYXAnO1xuaW1wb3J0IHsgdG9nZ2xlTWFyaywgYmFzZUtleW1hcCwgY2hhaW5Db21tYW5kcywgZXhpdENvZGUgfSBmcm9tICdwcm9zZW1pcnJvci1jb21tYW5kcyc7XG5pbXBvcnQgeyBzcGxpdExpc3RJdGVtLCBsaWZ0TGlzdEl0ZW0sIHNpbmtMaXN0SXRlbSB9IGZyb20gJ3Byb3NlbWlycm9yLXNjaGVtYS1saXN0JztcbmltcG9ydCB7IGhpc3RvcnksIHVuZG8sIHJlZG8gfSBmcm9tICdwcm9zZW1pcnJvci1oaXN0b3J5JztcbmltcG9ydCB7XG4gIGlucHV0UnVsZXMsIHdyYXBwaW5nSW5wdXRSdWxlLCB0ZXh0YmxvY2tUeXBlSW5wdXRSdWxlLFxuICBzbWFydFF1b3RlcywgZW1EYXNoLCBlbGxpcHNpcywgSW5wdXRSdWxlXG59IGZyb20gJ3Byb3NlbWlycm9yLWlucHV0cnVsZXMnO1xuXG5pbXBvcnQgeyBtYXJrSW5wdXRSdWxlIH0gZnJvbSAnbmd4LWVkaXRvci9oZWxwZXJzJztcblxuaW50ZXJmYWNlIE9wdGlvbnMge1xuICBoaXN0b3J5OiBib29sZWFuO1xuICBrZXlib2FyZFNob3J0Y3V0czogYm9vbGVhbjtcbiAgaW5wdXRSdWxlczogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIFNob3J0Y3V0T3B0aW9ucyB7XG4gIGhpc3Rvcnk6IGJvb2xlYW47XG59XG5cbmNvbnN0IGlzTWFjT3MgPSB0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyA/IC9NYWMvLnRlc3QobmF2aWdhdG9yLnBsYXRmb3JtKSA6IGZhbHNlXG5cbi8vIElucHV0IHJ1bGVzIHJlZjogaHR0cHM6Ly9naXRodWIuY29tL1Byb3NlTWlycm9yL3Byb3NlbWlycm9yLWV4YW1wbGUtc2V0dXAvXG5cbi8vIDogKE5vZGVUeXBlKSDihpIgSW5wdXRSdWxlXG4vLyBHaXZlbiBhIGJsb2NrcXVvdGUgbm9kZSB0eXBlLCByZXR1cm5zIGFuIGlucHV0IHJ1bGUgdGhhdCB0dXJucyBgXCI+IFwiYFxuLy8gYXQgdGhlIHN0YXJ0IG9mIGEgdGV4dGJsb2NrIGludG8gYSBibG9ja3F1b3RlLlxuY29uc3QgYmxvY2tRdW90ZVJ1bGUgPSAobm9kZVR5cGU6IE5vZGVUeXBlKTogSW5wdXRSdWxlID0+IHtcbiAgcmV0dXJuIHdyYXBwaW5nSW5wdXRSdWxlKC9eXFxzKj5cXHMkLywgbm9kZVR5cGUpO1xufTtcblxuLy8gOiAoTm9kZVR5cGUpIOKGkiBJbnB1dFJ1bGVcbi8vIEdpdmVuIGEgbGlzdCBub2RlIHR5cGUsIHJldHVybnMgYW4gaW5wdXQgcnVsZSB0aGF0IHR1cm5zIGEgbnVtYmVyXG4vLyBmb2xsb3dlZCBieSBhIGRvdCBhdCB0aGUgc3RhcnQgb2YgYSB0ZXh0YmxvY2sgaW50byBhbiBvcmRlcmVkIGxpc3QuXG5jb25zdCBvcmRlcmVkTGlzdFJ1bGUgPSAobm9kZVR5cGU6IE5vZGVUeXBlKTogSW5wdXRSdWxlID0+IHtcbiAgcmV0dXJuIHdyYXBwaW5nSW5wdXRSdWxlKFxuICAgIC9eKFxcZCspXFwuXFxzJC8sXG4gICAgbm9kZVR5cGUsXG4gICAgbWF0Y2ggPT4gKHsgb3JkZXI6ICttYXRjaFsxXSB9KSxcbiAgICAobWF0Y2gsIG5vZGUpID0+IG5vZGUuY2hpbGRDb3VudCArIG5vZGUuYXR0cnMub3JkZXIgPT09ICttYXRjaFsxXVxuICApO1xufTtcblxuLy8gOiAoTm9kZVR5cGUpIOKGkiBJbnB1dFJ1bGVcbi8vIEdpdmVuIGEgbGlzdCBub2RlIHR5cGUsIHJldHVybnMgYW4gaW5wdXQgcnVsZSB0aGF0IHR1cm5zIGEgYnVsbGV0XG4vLyAoZGFzaCwgcGx1c2gsIG9yIGFzdGVyaXNrKSBhdCB0aGUgc3RhcnQgb2YgYSB0ZXh0YmxvY2sgaW50byBhXG4vLyBidWxsZXQgbGlzdC5cbmNvbnN0IGJ1bGxldExpc3RSdWxlID0gKG5vZGVUeXBlOiBOb2RlVHlwZSk6IElucHV0UnVsZSA9PiB7XG4gIHJldHVybiB3cmFwcGluZ0lucHV0UnVsZSgvXlxccyooWy0rKl0pXFxzJC8sIG5vZGVUeXBlKTtcbn07XG5cbi8vIDogKE5vZGVUeXBlKSDihpIgSW5wdXRSdWxlXG4vLyBHaXZlbiBhIGNvZGUgYmxvY2sgbm9kZSB0eXBlLCByZXR1cm5zIGFuIGlucHV0IHJ1bGUgdGhhdCB0dXJucyBhXG4vLyB0ZXh0YmxvY2sgc3RhcnRpbmcgd2l0aCB0aHJlZSBiYWNrdGlja3MgaW50byBhIGNvZGUgYmxvY2suXG5jb25zdCBjb2RlQmxvY2tSdWxlID0gKG5vZGVUeXBlOiBOb2RlVHlwZSk6IElucHV0UnVsZSA9PiB7XG4gIHJldHVybiB0ZXh0YmxvY2tUeXBlSW5wdXRSdWxlKC9eYGBgJC8sIG5vZGVUeXBlKTtcbn07XG5cbi8vIDogKE5vZGVUeXBlLCBudW1iZXIpIOKGkiBJbnB1dFJ1bGVcbi8vIEdpdmVuIGEgbm9kZSB0eXBlIGFuZCBhIG1heGltdW0gbGV2ZWwsIGNyZWF0ZXMgYW4gaW5wdXQgcnVsZSB0aGF0XG4vLyB0dXJucyB1cCB0byB0aGF0IG51bWJlciBvZiBgI2AgY2hhcmFjdGVycyBmb2xsb3dlZCBieSBhIHNwYWNlIGF0XG4vLyB0aGUgc3RhcnQgb2YgYSB0ZXh0YmxvY2sgaW50byBhIGhlYWRpbmcgd2hvc2UgbGV2ZWwgY29ycmVzcG9uZHMgdG9cbi8vIHRoZSBudW1iZXIgb2YgYCNgIHNpZ25zLlxuY29uc3QgaGVhZGluZ1J1bGUgPSAobm9kZVR5cGU6IE5vZGVUeXBlLCBtYXhMZXZlbDogbnVtYmVyKTogSW5wdXRSdWxlID0+IHtcbiAgcmV0dXJuIHRleHRibG9ja1R5cGVJbnB1dFJ1bGUoXG4gICAgbmV3IFJlZ0V4cCgnXigjezEsJyArIG1heExldmVsICsgJ30pXFxcXHMkJyksXG4gICAgbm9kZVR5cGUsXG4gICAgKG1hdGNoKSA9PiAoeyBsZXZlbDogbWF0Y2hbMV0ubGVuZ3RoIH0pXG4gICk7XG59O1xuXG4vLyA6IChNYXJrVHlwZSkg4oaSIElucHV0UnVsZVxuLy8gV3JhcHMgbWF0Y2hpbmcgdGV4dCB3aXRoIGJvbGQgbWFya1xuY29uc3QgYm9sZFJ1bGUgPSAobWFya1R5cGU6IE1hcmtUeXBlKTogSW5wdXRSdWxlID0+IHtcbiAgcmV0dXJuIG1hcmtJbnB1dFJ1bGUoLyg/Ol58XFxzKSgoPzpcXCpcXCp8X18pKCg/OlteKl9dKykpKD86XFwqXFwqfF9fKSkkLywgbWFya1R5cGUpXG59XG5cbi8vIDogKE1hcmtUeXBlKSDihpIgSW5wdXRSdWxlXG4vLyBXcmFwcyBtYXRjaGluZyB0ZXh0IHdpdGggZW0gbWFya1xuY29uc3QgZW1SdWxlID0gKG1hcmtUeXBlOiBNYXJrVHlwZSk6IElucHV0UnVsZSA9PiB7XG4gIHJldHVybiBtYXJrSW5wdXRSdWxlKC8oPzpefFxccykoKD86XFwqfF8pKCg/OlteKl9dKykpKD86XFwqfF8pKSQvLCBtYXJrVHlwZSlcbn1cblxuLy8gOiAoU2NoZW1hKSDihpIgUGx1Z2luXG4vLyBBIHNldCBvZiBpbnB1dCBydWxlcyBmb3IgY3JlYXRpbmcgdGhlIGJhc2ljIGJsb2NrIHF1b3RlcywgbGlzdHMsXG4vLyBjb2RlIGJsb2NrcywgYW5kIGhlYWRpbmcuXG5jb25zdCBidWlsZElucHV0UnVsZXMgPSAoc2NoZW1hOiBTY2hlbWEpOiBQbHVnaW4gPT4ge1xuICBjb25zdCBydWxlcyA9IHNtYXJ0UXVvdGVzLmNvbmNhdChlbGxpcHNpcywgZW1EYXNoKTtcblxuICBydWxlcy5wdXNoKGJvbGRSdWxlKHNjaGVtYS5tYXJrcy5zdHJvbmcpKTtcbiAgcnVsZXMucHVzaChlbVJ1bGUoc2NoZW1hLm1hcmtzLmVtKSk7XG4gIHJ1bGVzLnB1c2goYmxvY2tRdW90ZVJ1bGUoc2NoZW1hLm5vZGVzLmJsb2NrcXVvdGUpKTtcbiAgcnVsZXMucHVzaChvcmRlcmVkTGlzdFJ1bGUoc2NoZW1hLm5vZGVzLm9yZGVyZWRfbGlzdCkpO1xuICBydWxlcy5wdXNoKGJ1bGxldExpc3RSdWxlKHNjaGVtYS5ub2Rlcy5idWxsZXRfbGlzdCkpO1xuICBydWxlcy5wdXNoKGNvZGVCbG9ja1J1bGUoc2NoZW1hLm5vZGVzLmNvZGVfYmxvY2spKTtcbiAgcnVsZXMucHVzaChoZWFkaW5nUnVsZShzY2hlbWEubm9kZXMuaGVhZGluZywgNikpO1xuXG4gIHJldHVybiBpbnB1dFJ1bGVzKHsgcnVsZXMgfSk7XG59O1xuXG5jb25zdCBnZXRLZXlib2FyZFNob3J0Y3V0cyA9IChzY2hlbWE6IFNjaGVtYSwgb3B0aW9uczogU2hvcnRjdXRPcHRpb25zKSA9PiB7XG4gIGNvbnN0IGhpc3RvcnlLZXlNYXA6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuICBoaXN0b3J5S2V5TWFwWydNb2QteiddID0gdW5kbztcbiAgaWYgKGlzTWFjT3MpIHtcbiAgICBoaXN0b3J5S2V5TWFwWydTaGlmdC1Nb2QteiddID0gcmVkbztcbiAgfSBlbHNlIHtcbiAgICBoaXN0b3J5S2V5TWFwWydNb2QteSddID0gcmVkbztcbiAgfVxuXG4gIGNvbnN0IHBsdWdpbnMgPSBbXG4gICAga2V5bWFwKHtcbiAgICAgICdNb2QtYic6IHRvZ2dsZU1hcmsoc2NoZW1hLm1hcmtzLnN0cm9uZyksXG4gICAgICAnTW9kLWknOiB0b2dnbGVNYXJrKHNjaGVtYS5tYXJrcy5lbSksXG4gICAgICAnTW9kLXUnOiB0b2dnbGVNYXJrKHNjaGVtYS5tYXJrcy51KSxcbiAgICAgICdNb2QtYCc6IHRvZ2dsZU1hcmsoc2NoZW1hLm1hcmtzLmNvZGUpLFxuICAgIH0pLFxuICAgIGtleW1hcCh7XG4gICAgICBFbnRlcjogc3BsaXRMaXN0SXRlbShzY2hlbWEubm9kZXMubGlzdF9pdGVtKSxcbiAgICAgICdTaGlmdC1FbnRlcic6IGNoYWluQ29tbWFuZHMoZXhpdENvZGUsIChzdGF0ZSwgZGlzcGF0Y2gpID0+IHtcbiAgICAgICAgY29uc3QgdHIgPSBzdGF0ZS50cjtcbiAgICAgICAgY29uc3QgYnIgPSBzY2hlbWEubm9kZXMuaGFyZF9icmVhaztcbiAgICAgICAgZGlzcGF0Y2godHIucmVwbGFjZVNlbGVjdGlvbldpdGgoYnIuY3JlYXRlKCkpLnNjcm9sbEludG9WaWV3KCkpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pLFxuICAgICAgJ01vZC1bJzogbGlmdExpc3RJdGVtKHNjaGVtYS5ub2Rlcy5saXN0X2l0ZW0pLFxuICAgICAgJ01vZC1dJzogc2lua0xpc3RJdGVtKHNjaGVtYS5ub2Rlcy5saXN0X2l0ZW0pLFxuICAgICAgVGFiOiBzaW5rTGlzdEl0ZW0oc2NoZW1hLm5vZGVzLmxpc3RfaXRlbSlcbiAgICB9KSxcbiAgICBrZXltYXAoYmFzZUtleW1hcClcbiAgXTtcblxuICBpZiAob3B0aW9ucy5oaXN0b3J5KSB7XG4gICAgcGx1Z2lucy5wdXNoKGtleW1hcChoaXN0b3J5S2V5TWFwKSk7XG4gIH1cblxuICByZXR1cm4gcGx1Z2lucztcbn07XG5cbmNvbnN0IGdldERlZmF1bHRQbHVnaW5zID0gKHNjaGVtYTogU2NoZW1hLCBvcHRpb25zOiBPcHRpb25zKTogUGx1Z2luW10gPT4ge1xuICBjb25zdCBwbHVnaW5zOiBQbHVnaW5bXSA9IFtdO1xuXG4gIGlmIChvcHRpb25zLmtleWJvYXJkU2hvcnRjdXRzKSB7XG4gICAgcGx1Z2lucy5wdXNoKC4uLmdldEtleWJvYXJkU2hvcnRjdXRzKHNjaGVtYSwgeyBoaXN0b3J5OiBvcHRpb25zLmhpc3RvcnkgfSkpO1xuICB9XG5cbiAgaWYgKG9wdGlvbnMuaGlzdG9yeSkge1xuICAgIHBsdWdpbnMucHVzaChoaXN0b3J5KCkpO1xuICB9XG5cbiAgaWYgKG9wdGlvbnMuaW5wdXRSdWxlcykge1xuICAgIHBsdWdpbnMucHVzaChidWlsZElucHV0UnVsZXMoc2NoZW1hKSk7XG4gIH1cblxuICByZXR1cm4gcGx1Z2lucztcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGdldERlZmF1bHRQbHVnaW5zO1xuIl19