import { chainCommands, createParagraphNear, liftEmptyBlock, newlineInCode, splitBlock } from 'prosemirror-commands';
import { DOMParser } from 'prosemirror-model';
import MarkCommand from './commands/Mark';
import ListCommand from './commands/ListItem';
import LinkCommand from './commands/Link';
import HeadingCommand from './commands/Heading';
import ImageCommand from './commands/Image';
import TextColorCommand from './commands/TextColor';
import TextAlignCommand from './commands/TextAlign';
const execMark = (name, toggle = false) => {
    return (state, dispatch) => {
        const command = new MarkCommand(name);
        if (!toggle) {
            return command.apply()(state, dispatch);
        }
        return command.toggle()(state, dispatch);
    };
};
class EditorCommands {
    constructor(view) {
        this.applyTrx = (tr) => {
            this.state = this.state.apply(tr !== null && tr !== void 0 ? tr : this.tr);
            this.tr = this.state.tr;
            this.tr.setMeta('APPLIED_TRX', true);
        };
        this.dispatch = (tr) => {
            this.applyTrx(tr);
        };
        if (!view) {
            throw Error('NgxEditor: Required view to initialize commands.');
        }
        this.view = view;
        this.state = view.state;
        this.tr = this.view.state.tr;
    }
    exec() {
        // No changes applied
        if (!this.tr.getMeta('APPLIED_TRX')) {
            return false;
        }
        const forceEmit = !this.view.state.doc.eq(this.state.doc);
        this.view.updateState(this.state);
        const tr = this.tr
            .setMeta('FORCE_EMIT', forceEmit);
        this.view.dispatch(tr);
        return true;
    }
    focus() {
        this.view.focus();
        return this;
    }
    scrollIntoView() {
        this.tr.scrollIntoView();
        this.applyTrx();
        return this;
    }
    insertText(text) {
        this.tr.insertText(text);
        this.applyTrx();
        return this;
    }
    insertNewLine() {
        const newLineCommands = [newlineInCode, createParagraphNear, liftEmptyBlock, splitBlock];
        chainCommands(...newLineCommands)(this.state, this.dispatch);
        return this;
    }
    applyMark(name) {
        execMark(name, false)(this.state, this.dispatch);
        return this;
    }
    toggleMark(name) {
        execMark(name, true)(this.state, this.dispatch);
        return this;
    }
    bold() {
        execMark('strong')(this.state, this.dispatch);
        return this;
    }
    toggleBold() {
        execMark('strong', true)(this.state, this.dispatch);
        return this;
    }
    italics() {
        execMark('em')(this.state, this.dispatch);
        return this;
    }
    toggleItalics() {
        execMark('em', true)(this.state, this.dispatch);
        return this;
    }
    underline() {
        execMark('u')(this.state, this.dispatch);
        return this;
    }
    toggleUnderline() {
        execMark('u', true)(this.state, this.dispatch);
        return this;
    }
    strike() {
        execMark('s')(this.state, this.dispatch);
        return this;
    }
    toggleStrike() {
        execMark('s', true)(this.state, this.dispatch);
        return this;
    }
    code() {
        execMark('code')(this.state, this.dispatch);
        return this;
    }
    toggleCode() {
        execMark('code', true)(this.state, this.dispatch);
        return this;
    }
    toggleOrderedList() {
        const command = new ListCommand(false);
        command.toggle()(this.state, this.dispatch);
        return this;
    }
    toggleBulletList() {
        const command = new ListCommand(true);
        command.toggle()(this.state, this.dispatch);
        return this;
    }
    toggleHeading(level) {
        const command = new HeadingCommand(level);
        command.toggle()(this.state, this.dispatch);
        return this;
    }
    insertLink(text, attrs) {
        const command = new LinkCommand();
        command.insert(text, attrs)(this.state, this.dispatch);
        return this;
    }
    updateLink(attrs) {
        const command = new LinkCommand();
        command.update(attrs)(this.state, this.dispatch);
        return this;
    }
    insertImage(src, attrs = {}) {
        const command = new ImageCommand();
        command.insert(src, attrs)(this.state, this.dispatch);
        return this;
    }
    textColor(color) {
        const command = new TextColorCommand('text_color');
        command.apply({ color })(this.state, this.dispatch);
        return this;
    }
    backgroundColor(color) {
        const command = new TextColorCommand('text_background_color');
        command.apply({ backgroundColor: color })(this.state, this.dispatch);
        return this;
    }
    removeTextColor() {
        const command = new TextColorCommand('text_color');
        command.remove()(this.state, this.dispatch);
        return this;
    }
    removeBackgroundColor() {
        const command = new TextColorCommand('text_background_color');
        command.remove()(this.state, this.dispatch);
        return this;
    }
    align(p) {
        const command = new TextAlignCommand(p);
        command.toggle()(this.state, this.dispatch);
        return this;
    }
    insertHTML(html) {
        const { selection, schema, tr } = this.state;
        const { from, to } = selection;
        const element = document.createElement('div');
        element.innerHTML = html.trim();
        const slice = DOMParser.fromSchema(schema).parseSlice(element);
        const transaction = tr.replaceRange(from, to, slice);
        this.applyTrx(transaction);
        return this;
    }
}
export default EditorCommands;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWRpdG9yQ29tbWFuZHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtZWRpdG9yL3NyYy9saWIvRWRpdG9yQ29tbWFuZHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUNMLGFBQWEsRUFBRSxtQkFBbUIsRUFBRSxjQUFjLEVBQ2xELGFBQWEsRUFBRSxVQUFVLEVBQzFCLE1BQU0sc0JBQXNCLENBQUM7QUFDOUIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTlDLE9BQU8sV0FBVyxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sV0FBVyxNQUFNLHFCQUFxQixDQUFDO0FBQzlDLE9BQU8sV0FBMEIsTUFBTSxpQkFBaUIsQ0FBQztBQUN6RCxPQUFPLGNBQWlDLE1BQU0sb0JBQW9CLENBQUM7QUFDbkUsT0FBTyxZQUE0QixNQUFNLGtCQUFrQixDQUFDO0FBQzVELE9BQU8sZ0JBQWdCLE1BQU0sc0JBQXNCLENBQUM7QUFDcEQsT0FBTyxnQkFBMkIsTUFBTSxzQkFBc0IsQ0FBQztBQUUvRCxNQUFNLFFBQVEsR0FBRyxDQUFDLElBQVksRUFBRSxNQUFNLEdBQUcsS0FBSyxFQUFFLEVBQUU7SUFDaEQsT0FBTyxDQUFDLEtBQWtCLEVBQUUsUUFBbUMsRUFBRSxFQUFFO1FBQ2pFLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXRDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDekM7UUFFRCxPQUFPLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDM0MsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsTUFBTSxjQUFjO0lBS2xCLFlBQVksSUFBZ0I7UUFVcEIsYUFBUSxH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QUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUUzQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRjtBQUVELGVBQWUsY0FBYyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yU3RhdGUsIFRyYW5zYWN0aW9uIH0gZnJvbSAncHJvc2VtaXJyb3Itc3RhdGUnO1xuaW1wb3J0IHsgRWRpdG9yVmlldyB9IGZyb20gJ3Byb3NlbWlycm9yLXZpZXcnO1xuaW1wb3J0IHtcbiAgY2hhaW5Db21tYW5kcywgY3JlYXRlUGFyYWdyYXBoTmVhciwgbGlmdEVtcHR5QmxvY2ssXG4gIG5ld2xpbmVJbkNvZGUsIHNwbGl0QmxvY2tcbn0gZnJvbSAncHJvc2VtaXJyb3ItY29tbWFuZHMnO1xuaW1wb3J0IHsgRE9NUGFyc2VyIH0gZnJvbSAncHJvc2VtaXJyb3ItbW9kZWwnO1xuXG5pbXBvcnQgTWFya0NvbW1hbmQgZnJvbSAnLi9jb21tYW5kcy9NYXJrJztcbmltcG9ydCBMaXN0Q29tbWFuZCBmcm9tICcuL2NvbW1hbmRzL0xpc3RJdGVtJztcbmltcG9ydCBMaW5rQ29tbWFuZCwgeyBMaW5rQXR0cnMgfSBmcm9tICcuL2NvbW1hbmRzL0xpbmsnO1xuaW1wb3J0IEhlYWRpbmdDb21tYW5kLCB7IEhlYWRpbmdMZXZlbHMgfSBmcm9tICcuL2NvbW1hbmRzL0hlYWRpbmcnO1xuaW1wb3J0IEltYWdlQ29tbWFuZCwgeyBJbWFnZUF0dHJzIH0gZnJvbSAnLi9jb21tYW5kcy9JbWFnZSc7XG5pbXBvcnQgVGV4dENvbG9yQ29tbWFuZCBmcm9tICcuL2NvbW1hbmRzL1RleHRDb2xvcic7XG5pbXBvcnQgVGV4dEFsaWduQ29tbWFuZCwgeyBBbGlnbiB9IGZyb20gJy4vY29tbWFuZHMvVGV4dEFsaWduJztcblxuY29uc3QgZXhlY01hcmsgPSAobmFtZTogc3RyaW5nLCB0b2dnbGUgPSBmYWxzZSkgPT4ge1xuICByZXR1cm4gKHN0YXRlOiBFZGl0b3JTdGF0ZSwgZGlzcGF0Y2g6ICh0cjogVHJhbnNhY3Rpb24pID0+IHZvaWQpID0+IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IE1hcmtDb21tYW5kKG5hbWUpO1xuXG4gICAgaWYgKCF0b2dnbGUpIHtcbiAgICAgIHJldHVybiBjb21tYW5kLmFwcGx5KCkoc3RhdGUsIGRpc3BhdGNoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tbWFuZC50b2dnbGUoKShzdGF0ZSwgZGlzcGF0Y2gpO1xuICB9O1xufTtcblxuY2xhc3MgRWRpdG9yQ29tbWFuZHMge1xuICBwcml2YXRlIHZpZXc6IEVkaXRvclZpZXc7XG4gIHByaXZhdGUgc3RhdGU6IEVkaXRvclN0YXRlO1xuICBwcml2YXRlIHRyOiBUcmFuc2FjdGlvbjtcblxuICBjb25zdHJ1Y3Rvcih2aWV3OiBFZGl0b3JWaWV3KSB7XG4gICAgaWYgKCF2aWV3KSB7XG4gICAgICB0aHJvdyBFcnJvcignTmd4RWRpdG9yOiBSZXF1aXJlZCB2aWV3IHRvIGluaXRpYWxpemUgY29tbWFuZHMuJyk7XG4gICAgfVxuXG4gICAgdGhpcy52aWV3ID0gdmlldztcbiAgICB0aGlzLnN0YXRlID0gdmlldy5zdGF0ZTtcbiAgICB0aGlzLnRyID0gdGhpcy52aWV3LnN0YXRlLnRyO1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBseVRyeCA9ICh0cj86IFRyYW5zYWN0aW9uKSA9PiB7XG4gICAgdGhpcy5zdGF0ZSA9IHRoaXMuc3RhdGUuYXBwbHkodHIgPz8gdGhpcy50cik7XG4gICAgdGhpcy50ciA9IHRoaXMuc3RhdGUudHI7XG4gICAgdGhpcy50ci5zZXRNZXRhKCdBUFBMSUVEX1RSWCcsIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNwYXRjaCA9ICh0cjogVHJhbnNhY3Rpb24pOiB2b2lkID0+IHtcbiAgICB0aGlzLmFwcGx5VHJ4KHRyKTtcbiAgfVxuXG4gIGV4ZWMoKTogYm9vbGVhbiB7XG4gICAgLy8gTm8gY2hhbmdlcyBhcHBsaWVkXG4gICAgaWYgKCF0aGlzLnRyLmdldE1ldGEoJ0FQUExJRURfVFJYJykpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBmb3JjZUVtaXQgPSAhdGhpcy52aWV3LnN0YXRlLmRvYy5lcSh0aGlzLnN0YXRlLmRvYyk7XG4gICAgdGhpcy52aWV3LnVwZGF0ZVN0YXRlKHRoaXMuc3RhdGUpO1xuXG4gICAgY29uc3QgdHIgPSB0aGlzLnRyXG4gICAgICAuc2V0TWV0YSgnRk9SQ0VfRU1JVCcsIGZvcmNlRW1pdCk7XG5cbiAgICB0aGlzLnZpZXcuZGlzcGF0Y2godHIpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgZm9jdXMoKTogdGhpcyB7XG4gICAgdGhpcy52aWV3LmZvY3VzKCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzY3JvbGxJbnRvVmlldygpOiB0aGlzIHtcbiAgICB0aGlzLnRyLnNjcm9sbEludG9WaWV3KCk7XG4gICAgdGhpcy5hcHBseVRyeCgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgaW5zZXJ0VGV4dCh0ZXh0OiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnRyLmluc2VydFRleHQodGV4dCk7XG4gICAgdGhpcy5hcHBseVRyeCgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgaW5zZXJ0TmV3TGluZSgpOiB0aGlzIHtcbiAgICBjb25zdCBuZXdMaW5lQ29tbWFuZHMgPSBbbmV3bGluZUluQ29kZSwgY3JlYXRlUGFyYWdyYXBoTmVhciwgbGlmdEVtcHR5QmxvY2ssIHNwbGl0QmxvY2tdO1xuICAgIGNoYWluQ29tbWFuZHMoLi4ubmV3TGluZUNvbW1hbmRzKSh0aGlzLnN0YXRlLCB0aGlzLmRpc3BhdGNoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFwcGx5TWFyayhuYW1lOiBzdHJpbmcpOiB0aGlzIHtcbiAgICBleGVjTWFyayhuYW1lLCBmYWxzZSkodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b2dnbGVNYXJrKG5hbWU6IHN0cmluZyk6IHRoaXMge1xuICAgIGV4ZWNNYXJrKG5hbWUsIHRydWUpKHRoaXMuc3RhdGUsIHRoaXMuZGlzcGF0Y2gpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgYm9sZCgpOiB0aGlzIHtcbiAgICBleGVjTWFyaygnc3Ryb25nJykodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b2dnbGVCb2xkKCk6IHRoaXMge1xuICAgIGV4ZWNNYXJrKCdzdHJvbmcnLCB0cnVlKSh0aGlzLnN0YXRlLCB0aGlzLmRpc3BhdGNoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGl0YWxpY3MoKTogdGhpcyB7XG4gICAgZXhlY01hcmsoJ2VtJykodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b2dnbGVJdGFsaWNzKCk6IHRoaXMge1xuICAgIGV4ZWNNYXJrKCdlbScsIHRydWUpKHRoaXMuc3RhdGUsIHRoaXMuZGlzcGF0Y2gpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgdW5kZXJsaW5lKCk6IHRoaXMge1xuICAgIGV4ZWNNYXJrKCd1JykodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b2dnbGVVbmRlcmxpbmUoKTogdGhpcyB7XG4gICAgZXhlY01hcmsoJ3UnLCB0cnVlKSh0aGlzLnN0YXRlLCB0aGlzLmRpc3BhdGNoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHN0cmlrZSgpOiB0aGlzIHtcbiAgICBleGVjTWFyaygncycpKHRoaXMuc3RhdGUsIHRoaXMuZGlzcGF0Y2gpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgdG9nZ2xlU3RyaWtlKCk6IHRoaXMge1xuICAgIGV4ZWNNYXJrKCdzJywgdHJ1ZSkodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBjb2RlKCk6IHRoaXMge1xuICAgIGV4ZWNNYXJrKCdjb2RlJykodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b2dnbGVDb2RlKCk6IHRoaXMge1xuICAgIGV4ZWNNYXJrKCdjb2RlJywgdHJ1ZSkodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b2dnbGVPcmRlcmVkTGlzdCgpOiB0aGlzIHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IExpc3RDb21tYW5kKGZhbHNlKTtcbiAgICBjb21tYW5kLnRvZ2dsZSgpKHRoaXMuc3RhdGUsIHRoaXMuZGlzcGF0Y2gpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgdG9nZ2xlQnVsbGV0TGlzdCgpOiB0aGlzIHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IExpc3RDb21tYW5kKHRydWUpO1xuICAgIGNvbW1hbmQudG9nZ2xlKCkodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b2dnbGVIZWFkaW5nKGxldmVsOiBIZWFkaW5nTGV2ZWxzKTogdGhpcyB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBIZWFkaW5nQ29tbWFuZChsZXZlbCk7XG4gICAgY29tbWFuZC50b2dnbGUoKSh0aGlzLnN0YXRlLCB0aGlzLmRpc3BhdGNoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGluc2VydExpbmsodGV4dDogc3RyaW5nLCBhdHRyczogTGlua0F0dHJzKTogdGhpcyB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBMaW5rQ29tbWFuZCgpO1xuICAgIGNvbW1hbmQuaW5zZXJ0KHRleHQsIGF0dHJzKSh0aGlzLnN0YXRlLCB0aGlzLmRpc3BhdGNoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHVwZGF0ZUxpbmsoYXR0cnM6IExpbmtBdHRycyk6IHRoaXMge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgTGlua0NvbW1hbmQoKTtcbiAgICBjb21tYW5kLnVwZGF0ZShhdHRycykodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBpbnNlcnRJbWFnZShzcmM6IHN0cmluZywgYXR0cnM6IEltYWdlQXR0cnMgPSB7fSk6IHRoaXMge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgSW1hZ2VDb21tYW5kKCk7XG4gICAgY29tbWFuZC5pbnNlcnQoc3JjLCBhdHRycykodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0ZXh0Q29sb3IoY29sb3I6IHN0cmluZyk6IHRoaXMge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgVGV4dENvbG9yQ29tbWFuZCgndGV4dF9jb2xvcicpO1xuICAgIGNvbW1hbmQuYXBwbHkoeyBjb2xvciB9KSh0aGlzLnN0YXRlLCB0aGlzLmRpc3BhdGNoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGJhY2tncm91bmRDb2xvcihjb2xvcjogc3RyaW5nKTogdGhpcyB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBUZXh0Q29sb3JDb21tYW5kKCd0ZXh0X2JhY2tncm91bmRfY29sb3InKTtcbiAgICBjb21tYW5kLmFwcGx5KHsgYmFja2dyb3VuZENvbG9yOiBjb2xvciB9KSh0aGlzLnN0YXRlLCB0aGlzLmRpc3BhdGNoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHJlbW92ZVRleHRDb2xvcigpOiB0aGlzIHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFRleHRDb2xvckNvbW1hbmQoJ3RleHRfY29sb3InKTtcbiAgICBjb21tYW5kLnJlbW92ZSgpKHRoaXMuc3RhdGUsIHRoaXMuZGlzcGF0Y2gpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcmVtb3ZlQmFja2dyb3VuZENvbG9yKCk6IHRoaXMge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgVGV4dENvbG9yQ29tbWFuZCgndGV4dF9iYWNrZ3JvdW5kX2NvbG9yJyk7XG4gICAgY29tbWFuZC5yZW1vdmUoKSh0aGlzLnN0YXRlLCB0aGlzLmRpc3BhdGNoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFsaWduKHA6IEFsaWduKTogdGhpcyB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBUZXh0QWxpZ25Db21tYW5kKHApO1xuICAgIGNvbW1hbmQudG9nZ2xlKCkodGhpcy5zdGF0ZSwgdGhpcy5kaXNwYXRjaCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBpbnNlcnRIVE1MKGh0bWw6IHN0cmluZyk6IHRoaXMge1xuICAgIGNvbnN0IHsgc2VsZWN0aW9uLCBzY2hlbWEsIHRyIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHsgZnJvbSwgdG8gfSA9IHNlbGVjdGlvbjtcblxuICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWwudHJpbSgpO1xuICAgIGNvbnN0IHNsaWNlID0gRE9NUGFyc2VyLmZyb21TY2hlbWEoc2NoZW1hKS5wYXJzZVNsaWNlKGVsZW1lbnQpO1xuXG4gICAgY29uc3QgdHJhbnNhY3Rpb24gPSB0ci5yZXBsYWNlUmFuZ2UoZnJvbSwgdG8sIHNsaWNlKTtcbiAgICB0aGlzLmFwcGx5VHJ4KHRyYW5zYWN0aW9uKTtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEVkaXRvckNvbW1hbmRzO1xuIl19